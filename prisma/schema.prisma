generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////
// ENUMS
//////////////////////////////////////

enum Role {
  CUSTOMER
  ADMIN
  TECHNICIAN
}

enum SystemType {
  GRID
  OFF_GRID
  HYBRID
}

enum SystemStatus {
  ACTIVE
  NEEDS_ATTENTION
  INACTIVE
}

enum BatteryType {
  LEAD_ACID
  LITHIUM
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
}

enum AlertStatus {
  NEW
  ACKNOWLEDGED
  RESOLVED
}

enum MonitoringSource {
  MANUAL
  INTEGRATION
  TECHNICIAN
}

enum ServiceStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProductType {
  PANEL
  BATTERY
  INVERTER
  ACCESSORY
}

enum OrderStatus {
  DRAFT // Quote or admin-created
  PENDING // Awaiting payment
  PAID
  CANCELLED
  FAILED
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
}

//////////////////////////////////////
// USER & CUSTOMER
//////////////////////////////////////

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     Role   @default(CUSTOMER)

  name  String?
  image String?

  customer      Customer?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  serviceVisits ServiceVisit[]
}

model Customer {
  id      String  @id @default(cuid())
  name    String
  phone   String?
  address String?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  systems SolarSystem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

//////////////////////////////////////
// SOLAR SYSTEM (CORE)
//////////////////////////////////////

model SolarSystem {
  id               String       @id @default(cuid())
  name             String
  location         String
  installationDate DateTime
  systemType       SystemType
  status           SystemStatus @default(ACTIVE)

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  panelArray PanelArray?
  battery    Battery?
  inverter   Inverter?

  monitoring      MonitoringSnapshot[]
  healthScores    HealthScore[]
  alerts          Alert[]
  serviceRequests ServiceRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

//////////////////////////////////////
// ASSETS
//////////////////////////////////////

model PanelArray {
  id         String  @id @default(cuid())
  capacityKw Float
  brand      String?
  model      String?
  quantity   Int

  systemId String      @unique
  system   SolarSystem @relation(fields: [systemId], references: [id])
}

model Battery {
  id             String      @id @default(cuid())
  type           BatteryType
  capacityKwh    Float
  brand          String?
  model          String?
  installDate    DateTime
  healthEstimate Int?

  systemId String      @unique
  system   SolarSystem @relation(fields: [systemId], references: [id])
}

model Inverter {
  id                  String  @id @default(cuid())
  brand               String
  model               String
  capacityKw          Float
  serialNumber        String?
  supportsIntegration Boolean @default(false)

  systemId String      @unique
  system   SolarSystem @relation(fields: [systemId], references: [id])
}

//////////////////////////////////////
// MONITORING & HEALTH
//////////////////////////////////////

model MonitoringSnapshot {
  id                     String   @id @default(cuid())
  date                   DateTime
  estimatedGenerationKwh Float?
  inverterStatus         String?
  notes                  String?

  source MonitoringSource

  systemId String
  system   SolarSystem @relation(fields: [systemId], references: [id])

  createdAt DateTime @default(now())
}

model HealthScore {
  id         String @id @default(cuid())
  score      Int
  summary    String
  confidence Int

  systemId String
  system   SolarSystem @relation(fields: [systemId], references: [id])

  createdAt DateTime @default(now())
}

model Alert {
  id         String        @id @default(cuid())
  type       String
  message    String
  severity   AlertSeverity
  status     AlertStatus   @default(NEW)
  actionHint String?

  systemId String
  system   SolarSystem @relation(fields: [systemId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////
// SERVICE & MAINTENANCE
//////////////////////////////////////

model ServiceRequest {
  id          String        @id @default(cuid())
  issueType   String
  description String?
  priority    Int?
  status      ServiceStatus @default(OPEN)

  systemId String
  system   SolarSystem @relation(fields: [systemId], references: [id])

  visits ServiceVisit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceVisit {
  id               String  @id @default(cuid())
  findings         String?
  actionsTaken     String?
  partsReplaced    String?
  followUpRequired Boolean @default(false)

  serviceRequestId String
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])

  technicianId String?
  technician   User?   @relation(fields: [technicianId], references: [id])

  createdAt DateTime @default(now())
}

model Product {
  id               String      @id @default(cuid())
  name             String
  slug             String?     @unique
  type             ProductType
  brand            String
  model            String?
  shortDescription String?     @db.Text
  longDescription  String?     @db.Text
  mainImageUrl     String?
  imageUrls        String[]    @default([])
  price            Int
  stock            Int?        @default(0)
  active           Boolean     @default(true)

  // ✅ NEW — aggregate rating (0–5 scale, decimal allowed)
  rating Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]
  gallery    ProductImage[]
  discount   Discount?
  reviews    Review[]
}

model ProductImage {
  id      String  @id @default(cuid())
  url     String
  caption String?

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Discount {
  id         String @id @default(cuid())
  amount     Int?
  percentage Float?

  active Boolean @default(true)

  productId String  @unique
  product   Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id      Int      @id @default(autoincrement())
  user    String
  content String   @db.Text
  rating  Int
  date    DateTime @default(now())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Order {
  id          String      @id @default(cuid())
  status      OrderStatus @default(DRAFT)
  totalAmount Int // in kobo

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  systemId String?
  system   SolarSystem? @relation(fields: [systemId], references: [id])

  items   OrderItem[]
  payment Payment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String @id @default(cuid())
  quantity  Int
  unitPrice Int // snapshot price (important!)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])
}

model Payment {
  id     String        @id @default(cuid())
  amount Int // in kobo
  status PaymentStatus @default(INITIATED)

  paystackRef       String  @unique
  authorizationCode String?
  channel           String?

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////
// PROJECTS
//////////////////////////////////////

model Project {
  id String @id @default(cuid())

  title       String
  description String? @db.Text
  location    String?

  // main preview image
  imageUrl String?

  // gallery images
  images ProjectImage[]

  // mark featured projects (homepage, highlights, etc.)
  featured Boolean @default(false)

  projectDate DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectImage {
  id String @id @default(cuid())

  url     String
  caption String?

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}
